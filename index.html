<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>تجربة تأجير العجل - موبايل</title>
</head>
<body>
  <h1>تجربة العد التنازلي (3 عجلات)</h1>
  <div id="debug" style="background:#eee; padding:10px; margin:10px 0; font-size:14px;"></div>
  <div id="bikesContainer"></div>

  <audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // 🔥 إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBmGUwMrocACdo3eelRAvTMFWLD8Bc9SAo",
      authDomain: "sekl-8ceef.firebaseapp.com",
      databaseURL: "https://sekl-8ceef-default-rtdb.firebaseio.com",
      projectId: "sekl-8ceef",
      storageBucket: "sekl-8ceef.appspot.com",
      messagingSenderId: "805869746836",
      appId: "1:805869746836:web:be1900eae9d5b7c6f2d281"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const timers = {};
    const bikeCount = 3;

    const container = document.getElementById("bikesContainer");
    const debug = document.getElementById("debug");

    function log(msg) {
      debug.innerHTML += msg + "<br>";
    }

    for (let i = 1; i <= bikeCount; i++) {
      container.innerHTML += `
        <div style="border:1px solid #ccc; margin:5px; padding:10px;">
          <h3>عجلة ${i}</h3>
          <input id="person${i}" placeholder="اسم المستأجر">
          <input id="bike${i}" placeholder="اسم العجلة">
          <input id="duration${i}" type="number" placeholder="مدة بالدقايق">
          <button onclick="startRent(${i})">ابدأ</button>
          <button onclick="stopRent(${i})">إلغاء</button>
          <p id="countdown${i}">الوقت المتبقي: -</p>
        </div>
      `;
    }

    function startRent(i) {
      const person = document.getElementById(`person${i}`).value.trim();
      const bike = document.getElementById(`bike${i}`).value.trim();
      const mins = parseInt(document.getElementById(`duration${i}`).value);

      if (!person || !bike || isNaN(mins) || mins <= 0) {
        alert("ادخل البيانات كاملة");
        return;
      }

      const start = Date.now();
      const end = start + mins * 60 * 1000;

      log(`⏰ بدأ إيجار (${bike}) لـ (${person}) - ينتهي عند: ${new Date(end).toLocaleTimeString()}`);

      db.ref("bikes/" + i).set({
        person,
        bikeName: bike,
        startTime: start,
        endTime: end
      });
    }

    function stopRent(i) {
      db.ref("bikes/" + i).remove();
      log(`🛑 تم إلغاء إيجار العجلة ${i}`);
    }

    function updateCountdown(i, endTime, person, bikeName) {
      const el = document.getElementById(`countdown${i}`);
      if (timers[i]) clearInterval(timers[i]);

      function tick() {
        const now = Date.now();
        const diff = Math.floor((endTime - now) / 1000);

        if (diff <= 0) {
          el.innerText = `انتهى وقت ${bikeName} لـ ${person}`;
          document.getElementById("alarm").play();
          clearInterval(timers[i]);
          return;
        }

        const mins = Math.floor(diff / 60);
        const secs = diff % 60;
        el.innerText = `الوقت المتبقي: ${mins} دقيقة ${secs} ثانية`;
      }

      tick();
      timers[i] = setInterval(tick, 1000);
    }

    db.ref("bikes").on("value", snap => {
      const data = snap.val() || {};
      log("📥 تحديث من Firebase: " + JSON.stringify(data));

      for (let i = 1; i <= bikeCount; i++) {
        if (data[i]) {
          const { person, bikeName, endTime } = data[i];
          log(`➡️ تحميل إيجار للعجلة ${i}: ${person}, ${bikeName}, endTime=${endTime}`);
          updateCountdown(i, Number(endTime), person, bikeName);
        } else {
          document.getElementById(`countdown${i}`).innerText = "الوقت المتبقي: -";
          if (timers[i]) {
            clearInterval(timers[i]);
            timers[i] = null;
          }
        }
      }
    });
  </script>
</body>
</html>
