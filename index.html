<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØªØ£Ø¬ÙŠØ± Ø§Ù„Ø¹Ø¬Ù„ - Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</title>
</head>
<body>
  <h1>ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ</h1>
  <div id="bikesContainer"></div>

  <audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ðŸ”¥ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBmGUwMrocACdo3eelRAvTMFWLD8Bc9SAo",
      authDomain: "sekl-8ceef.firebaseapp.com",
      databaseURL: "https://sekl-8ceef-default-rtdb.firebaseio.com",
      projectId: "sekl-8ceef",
      storageBucket: "sekl-8ceef.appspot.com",
      messagingSenderId: "805869746836",
      appId: "1:805869746836:web:be1900eae9d5b7c6f2d281"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const timers = {};
    const bikeCount = 3; // ðŸ”¥ Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø¨Ø³

    const container = document.getElementById("bikesContainer");

    for (let i = 1; i <= bikeCount; i++) {
      container.innerHTML += `
        <div>
          <h3>Ø¹Ø¬Ù„Ø© ${i}</h3>
          <input id="person${i}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±">
          <input id="bike${i}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø¬Ù„Ø©">
          <input id="duration${i}" type="number" placeholder="Ù…Ø¯Ø© Ø¨Ø§Ù„Ø¯Ù‚Ø§ÙŠÙ‚">
          <button onclick="startRent(${i})">Ø§Ø¨Ø¯Ø£</button>
          <button onclick="stopRent(${i})">Ø¥Ù„ØºØ§Ø¡</button>
          <p id="countdown${i}">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: -</p>
        </div>
        <hr>
      `;
    }

    function startRent(i) {
      const person = document.getElementById(`person${i}`).value.trim();
      const bike = document.getElementById(`bike${i}`).value.trim();
      const mins = parseInt(document.getElementById(`duration${i}`).value);

      if (!person || !bike || isNaN(mins) || mins <= 0) {
        alert("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©");
        return;
      }

      const start = Date.now();
      const end = start + mins * 60 * 1000;

      console.log(`â° Ø¨Ø¯Ø¡ Ø¥ÙŠØ¬Ø§Ø± ${bike} Ù„Ù€ ${person}, ÙŠÙ†ØªÙ‡ÙŠ Ø¹Ù†Ø¯ ${end}`);

      db.ref("bikes/" + i).set({
        person,
        bikeName: bike,
        startTime: start,
        endTime: end
      });
    }

    function stopRent(i) {
      db.ref("bikes/" + i).remove();
    }

    function updateCountdown(i, endTime, person, bikeName) {
      const el = document.getElementById(`countdown${i}`);
      if (timers[i]) clearInterval(timers[i]);

      function tick() {
        const now = Date.now();
        const diff = Math.floor((endTime - now) / 1000);

        if (diff <= 0) {
          el.innerText = `Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª ${bikeName} Ù„Ù€ ${person}`;
          document.getElementById("alarm").play();
          clearInterval(timers[i]);
          return;
        }

        const mins = Math.floor(diff / 60);
        const secs = diff % 60;
        el.innerText = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${mins} Ø¯Ù‚ÙŠÙ‚Ø© ${secs} Ø«Ø§Ù†ÙŠØ©`;
      }

      tick();
      timers[i] = setInterval(tick, 1000);
    }

    db.ref("bikes").on("value", snap => {
      const data = snap.val() || {};
      console.log("ðŸ“¥ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase:", data);

      for (let i = 1; i <= bikeCount; i++) {
        if (data[i]) {
          const { person, bikeName, endTime } = data[i];
          updateCountdown(i, Number(endTime), person, bikeName);
        } else {
          document.getElementById(`countdown${i}`).innerText = "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: -";
          if (timers[i]) {
            clearInterval(timers[i]);
            timers[i] = null;
          }
        }
      }
    });
  </script>
</body>
</html>
