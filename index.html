<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>منصّة تأجير العجل</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    body { font-feature-settings: "ss01" on, "cv01" on; transition: background 0.4s; }
    .hide { display:none; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-emerald-50 text-gray-900 dark:from-gray-900 dark:to-gray-800 dark:text-gray-100 selection:bg-blue-200">
  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/70 dark:bg-gray-900/70 backdrop-blur border-b">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-4">
      <h1 class="text-xl font-bold text-blue-600">🚲 منصّة تأجير العجل</h1>
      <div class="ms-auto flex items-center gap-3">
        <span id="now" class="text-sm text-gray-600 dark:text-gray-300">—</span>
        <button id="toggleDark" class="text-xs rounded-lg border px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-800">🌙</button>
        <button id="clearAll" class="text-xs rounded-lg border px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-800">تفريغ الكل</button>
      </div>
    </div>
  </header>

  <!-- Stats -->
  <section class="mx-auto max-w-6xl px-4 py-4 grid grid-cols-2 sm:grid-cols-3 gap-3 text-sm">
    <div class="rounded-xl bg-emerald-100 dark:bg-emerald-900 p-3 text-center">
      <p>🚲 متاحة</p>
      <b id="availableCount">0</b>
    </div>
    <div class="rounded-xl bg-amber-100 dark:bg-amber-900 p-3 text-center">
      <p>⏳ مؤجرة</p>
      <b id="rentedCount">0</b>
    </div>
    <div class="col-span-2 sm:col-span-1">
      <input id="searchBox" class="w-full rounded-xl border px-3 py-2 text-sm focus:ring focus:ring-blue-200 dark:bg-gray-800 dark:border-gray-700" placeholder="🔍 ابحث بالاسم أو الرقم">
    </div>
  </section>

  <!-- Main -->
  <main class="mx-auto max-w-6xl px-4 py-6">
    <section id="bikes" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 inset-x-4 sm:left-1/2 sm:-translate-x-1/2 sm:w-[420px] rounded-xl border bg-white dark:bg-gray-800 shadow-lg p-4 text-sm hidden"></div>
  
  <!-- Alarm -->
  <audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "PUT-YOUR-API-KEY-HERE",
      authDomain: "YOUR-PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR-PROJECT-default-rtdb.firebaseio.com",
      projectId: "YOUR-PROJECT-ID",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Helpers
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    function fmt12(d){
      const date=(d instanceof Date)?d:new Date(d);
      let h=date.getHours();
      const m=String(date.getMinutes()).padStart(2,'0');
      const s=String(date.getSeconds()).padStart(2,'0');
      const ampm=h>=12?'م':'ص'; h=h%12; h=h?h:12;
      return `${h}:${m}:${s} ${ampm}`;
    }
    function toast(msg,type='info'){
      const el=$('#toast');
      el.classList.remove('hidden');
      el.className=`fixed bottom-4 inset-x-4 sm:left-1/2 sm:-translate-x-1/2 sm:w-[420px] rounded-xl border p-4 text-sm shadow-lg ${type==='error'?'bg-red-100 dark:bg-red-900 border-red-300':'bg-white dark:bg-gray-800 border-gray-200'}`;
      el.innerHTML=msg;
      clearTimeout(el._t);
      el._t=setTimeout(()=>el.classList.add('hidden'),2800);
    }

    // UI
    const BIKE_COUNT=12;
    const timers={};
    function bikeCard(i){
      return `
      <article class="group rounded-2xl border dark:border-gray-700 bg-white dark:bg-gray-800 p-4 shadow-sm hover:shadow-md transition">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-9 h-9 rounded-xl bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 grid place-items-center font-bold">${i}</div>
          <h3 class="text-base font-semibold">العجلة ${i}</h3>
          <span id="status${i}" class="ms-auto text-xs px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600">متاحة</span>
        </div>
        <input id="person${i}" class="w-full rounded-xl border dark:border-gray-700 mb-2 px-3 py-2 text-sm focus:ring focus:ring-blue-200 dark:bg-gray-900" placeholder="👤 اسم المستأجر"/>
        <input id="bike${i}" class="w-full rounded-xl border dark:border-gray-700 mb-2 px-3 py-2 text-sm focus:ring focus:ring-blue-200 dark:bg-gray-900" placeholder="🚲 اسم العجلة"/>
        <div class="grid grid-cols-2 gap-3">
          <input id="mins${i}" type="number" min="1" class="rounded-xl border dark:border-gray-700 px-3 py-2 text-sm focus:ring focus:ring-blue-200 dark:bg-gray-900" placeholder="⏱️ المدة (د)"/>
          <div id="return${i}" class="rounded-xl border dark:border-gray-700 bg-gray-50 dark:bg-gray-900 px-3 py-2 text-sm grid place-items-start">—</div>
        </div>
        <div class="mt-4 flex items-center gap-2">
          <button id="start${i}" class="flex-1 rounded-xl bg-blue-600 text-white px-4 py-2 text-sm font-semibold hover:bg-blue-700">▶️ بدء</button>
          <button id="stop${i}" class="flex-1 rounded-xl bg-rose-600 text-white px-4 py-2 text-sm font-semibold hover:bg-rose-700" disabled>⏹️ إنهاء</button>
        </div>
        <div id="cd${i}" class="mt-3 text-sm font-semibold text-gray-700 dark:text-gray-300">الوقت المتبقي: —</div>
      </article>`;
    }
    function renderGrid(){
      const wrap=$('#bikes');
      wrap.innerHTML=Array.from({length:BIKE_COUNT},(_,k)=>bikeCard(k+1)).join('');
      for(let i=1;i<=BIKE_COUNT;i++){
        $('#start'+i).addEventListener('click',()=>startRent(i));
        $('#stop'+i).addEventListener('click',()=>stopRent(i));
      }
    }

    // Logic
    function startRent(i){
      const person=$('#person'+i).value.trim();
      const bike=$('#bike'+i).value.trim();
      const mins=parseInt($('#mins'+i).value,10);
      if(!person||!bike||!mins||mins<=0){ toast('⚠️ أدخل البيانات كاملة', 'error'); return; }
      const start=Date.now(), end=start+mins*60*1000;
      db.ref('bikes/'+i).set({person,bikeName:bike,startTime:start,endTime:end});
    }
    function stopRent(i){ db.ref('bikes/'+i).remove(); }
    function setDisabled(i,on){
      $('#person'+i).disabled=on; $('#bike'+i).disabled=on; $('#mins'+i).disabled=on;
      $('#start'+i).disabled=on; $('#stop'+i).disabled=!on;
      $('#status'+i).textContent=on?'مؤجرة':'متاحة';
      $('#status'+i).className='ms-auto text-xs px-2 py-1 rounded-full '+(on?'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200':'bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-200');
    }
    function startCountdown(i,end,person,bike){
      const el=$('#cd'+i), ret=$('#return'+i);
      if(timers[i]) clearInterval(timers[i]);
      function tick(){
        const now=Date.now(); let diff=Math.floor((end-now)/1000);
        if(diff<=0){ el.textContent=`⏰ انتهى الوقت لـ "${bike}" (${person})`; $('#alarm').play().catch(()=>{}); clearInterval(timers[i]); setDisabled(i,false); ret.textContent='—'; return; }
        const m=Math.floor(diff/60), s=diff%60;
        el.textContent=`الوقت المتبقي: ${m} دقيقة و ${String(s).padStart(2,'0')} ثانية`;
        ret.textContent=fmt12(end);
      }
      tick(); timers[i]=setInterval(tick,1000);
    }
    function stopCountdown(i){ if(timers[i]){clearInterval(timers[i]);timers[i]=null;} $('#cd'+i).textContent='الوقت المتبقي: —'; $('#return'+i).textContent='—'; setDisabled(i,false); }
    function bindRealtime(){
      db.ref('bikes').on('value',snap=>{
        const data=snap.val()||{}; let rented=0;
        for(let i=1;i<=BIKE_COUNT;i++){
          if(data[i]){ const {person,bikeName,endTime}=data[i]; $('#person'+i).value=person||''; $('#bike'+i).value=bikeName||''; setDisabled(i,true); startCountdown(i,Number(endTime),person,bikeName); rented++; }
          else{ stopCountdown(i); $('#person'+i).value=''; $('#bike'+i).value=''; $('#mins'+i).value=''; }
        }
        $('#rentedCount').textContent=rented; $('#availableCount').textContent=BIKE_COUNT-rented;
      });
    }

    // Time & dark mode
    function tickNow(){ $('#now').textContent=fmt12(new Date()); }
    $('#toggleDark').onclick=()=>document.documentElement.classList.toggle('dark');
    $('#clearAll').onclick=()=>{ if(confirm('مسح كل الحجوزات؟')) db.ref('bikes').remove(); };

    // Search filter
    $('#searchBox').addEventListener('input',e=>{
      const val=e.target.value.toLowerCase();
      $$('#bikes article').forEach(card=>{
        card.style.display=card.textContent.toLowerCase().includes(val)?'':'none';
      });
    });

    // Boot
    renderGrid(); bindRealtime(); tickNow(); setInterval(tickNow,1000);
  </script>
</body>
</html>
